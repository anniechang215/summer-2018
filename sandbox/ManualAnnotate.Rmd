

This is the code for manually annotating samples.
Goals: 
- get a set of manually annotated drug/sex/tissue labels that we will use to assess
- get more familiar with GEO expression metadata


Packages
```{r}
require('tidyverse')
require('MetaIntegrator')
```

Here is the code I used to randomly select studies:
```{r}
drug_pert_auto <- read.csv("data/single_drug_perturbations-p1.0.csv", stringsAsFactors = FALSE)

# we only want the human data for now
# - note - we are also extracting data that is [human, other organism] - this is why we use "str_detect" instead of organism == "human"
drug_pert_auto_human <- filter(drug_pert_auto, str_detect(organism, "human"))
nrow(drug_pert_auto_human) # 3122 - always good to check how many rows

# get the list of unique studies
list_geo_studies <- unique(drug_pert_auto_human$geo_id)
length(list_geo_studies) # 225 GEO studies

# here we set a random seed so that we get the same random list every time
#  - read abt why: http://www.statisticshowto.com/random-seed-definition/
# This is something you will have to do whenever you introduce randomness so we can reproduce it.
# This command should be performed *right before* selecting the studies
set.seed(711)

# sample() is used to randomly sample data - look it up and understand what the input + output is (we are looking at sample() from base R)
rand_studies <- sample(list_geo_studies, 30, replace=FALSE)

# write it out so that we have it for reference
write.table(data.frame(rand_studies), file="data/manual_annot/list_30.txt", sep="\t", row.names=FALSE, col.names=FALSE, quote=FALSE)

```


Structure of the data frame

| study | sample | drug | tissue | sex | disease | organism | other |
 | ---- | ------ | --- | ---- | --- | --- | --- | --- | 

Note on columns:
 * "study" : study id 
 * "sample" : the sample_id - should be the geo_accession
 * "drug" : "control" or drug name
 * "tissue" : NA if no info present
 * "sex" : NA if no sex labels are present, "male" or "female"
 * "disease" : include if the study has this info
     + states are: "normal" + names of whatever disease state
 * "organism" : if the study has humans + another organism this is needed - otherwise skip
 * "other": if there's something else you need to include

How to structure your code:
* Create an .Rmd that contains the code for manual annotation of all the studies you look at
* Include the study name as the header of that section with "####"
  + include any notes you have on the study, observations following the study ID
* Save the output to "data/manual_annot/<GSE_ID>_extracted.txt"


Example:

#### GSE70784
My notes: Acetominophen study, multiple time points, some responders

Download the study, look at the pData
```{r}
study_id <- "GSE70784"
gse <- getGEOData(study_id)
pData <- gse$originalData$GSE70784$pheno
View(pData)
```

Look up the study in GEO. Make sure you understand generally what the categories are. 

Select the appropriate columns - this will be different for every study
```{r}
# Based on looking at pData:
#   drug - "treatment:ch2"
#   tissue - "tissue:ch2"
#   sex - "gender:ch2" 
# It doesn't appear to have info on disease state --> we will set to "normal"

extracted_data <- pData[,c("geo_accession", "treatment:ch2", "tissue:ch2", "gender:ch2")]

# rename columns to proper names based on the mapping you created
extracted_data2 <- rename(extracted_data, sample="geo_accession", drug="treatment:ch2", tissue="tissue:ch2", sex="gender:ch2")
```


Rename some of the labels - this will make it more standardized
```{r}
summary(apply(extracted_data2, 2, as.factor)) # this tells us what levels are present, and will help

extracted_data3 <- extracted_data2


# You will have to do this mapping differently for each study
# Look up ?recode
extracted_data3$sex <- recode(extracted_data2$sex,"Male"="male", "Female"="female")
extracted_data3$drug <- recode(extracted_data2$drug, "Placebo"="control")

# check that this worked
summary(apply(extracted_data3, 2, as.factor)) 
```

Setting columns that will be sometimes be the same across the entire study
```{r}
# Adds a column
# make sure that extracted.data is a "data.frame" before doing this 
#  - otherwise it does not work to
extracted_data3$study <- study_id
extracted_data3$organism <- "human" # we know they are all human
extracted_data3$disease <- "normal" # based on reading study info, all normal
extracted_data3$other <- NA # there was no other info I wanted to include
```


Reorganizing and writing out the data frame

```{r}
# reorder the columns so that they are always the same
col.order <- c("study", "sample", "drug", "tissue", "sex" , "disease", "organism", "other" )
ext_data_reordered <- extracted_data3[,col.order]

# what does sprintf do? Try it - does this make sense
write.table(ext_data_reordered, sprintf("data/manual_annot/%s_extracted.txt", study_id))
```

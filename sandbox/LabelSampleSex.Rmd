

Goal:
Download studies and label sample sex.

High-level questions we want to answer:
1) What is the sex breakdown of each drug instance (`id` row) in terms of controls (`control_id`) and pert samples (`pert_id`)?
2) What is the sex breakdown of each study `geo_id`?

This will help us a) understand both the sex-bias in experiments and b) identify studies for the meta-analysis (these will have more than eight samples).

Learning goals:
* structure of microarray data from GEO, how to download/manipulate
* how to sex label microarray data

General questions to think abt when looking at a study:
* What are the different experimental groups? How many are in each group?
* What cell type is it? cell line? primary cell? tissue?
* What drugs are applied to which sample?
* Are any of the samples from the source but at different time points?



### Try sex labeling an example
We'll look at study GSE21477. Note: these are primary cells, not tissues, but primary cells still have sexes. 

##### Mapping probes to genes
Each microarray has a different set of probes. We need to match these probe_ids to genes before we are able to do comparisons. 
We are going to use the built in MetaIntegrator functionality to do this (see the `keys` field). When I did my analysis, I wasn't initially using MetaIntegrator, so I did this by mapping to Entrez IDs first. Take a look at the `keys` field - these are 'HGNC' symbols. 


##### Visual examination
Identify which rows of the study are probes for `XIST` (X chromosome) and `RPS4Y1` (Y chromosome gene).
Extract these rows. Plot each point (GSM) with x coordinates as XIST values, y coordinates as RPS4Y1 values.
Do the samples divide into two clusters? What are the outliers?
Think about how you could use this to label sample sex. 

This is the code I used to sanity check sex labels:
Note - you do not have the sex labels yet - so you will have to adjust it so it does not color the points. 
See if you can sex label your samples, and then plot with these labels. 
Also I recommend running each line of code instead of using the function, and make sure you understand it.
```{r}
sanityCheckSexLabels <- function(expData, keys.vec, sex.labels){
  
  # we have a list of genes, names of the gene list are probes
  # the probes index into the expression data 
  xist.probe <- names(keys.vec)[as.vector(keys.vec)=="XIST"] # XIST, ENSG00000229807
  print(xist.probe)
  xist.vals <- expData[xist.probe,]
  if (length(xist.probe)> 1){ xist.vals <- rowMeans(xist.vals, na.rm=TRUE)}
  rps4y1.probe <- names(keys.vec)[as.vector(keys.vec)=="RPS4Y1"] # RPS4Y1, ENSG00000129824
  print(rps4y1.probe)
  rpys4y1.vals <- expData[rpsy41.probe,]
  if (length(rps4y1.probe)> 1){ rps4y1.vals <- rowMeans(rps4y1.vals, na.rm=TRUE)}
  
  plot(xist.vals, rpsy41.vals,
       col=ifelse(sex.labels=="female", "red", "blue"), ylab="RPS4Y1", xlab="XIST")  
}
```


#### Code for clustering 
* Look up kmeans - what does this do? (this may help http://bigdata-madesimple.com/possibly-the-simplest-way-to-explain-k-means-algorithm/)
* What is supervised vs. unsupervised learning?
* Look at the kmeans R function - what are the the arguments? why do we use a two below?
```{r}
ssProbes.df <- expData[c(xist.probe, rpsy41.probe),] # extract the rows with the probes
# the rows are the probes, the columns are the samples
# the value of each element is the expression of that probe in that sample
cl <- kmeans(ssProbes.df, 2) # use kmeans to cluster

# cl$cluster labels each sample

# which cluster is f? which cluster is m?

# color by cluster in the plot - see code above
```

How do these match with the sex labels in the pheno data (you will likely have to view the pheno data frame to pick which ones).
How many match? How many are mismatches? Use "==" to compare the two lists. 

###### Sex labeling with massiR
massiR sex-labels by clustering on Y chromosome probe expression levels.

To start, you need a list of Y chromosome genes:
```{r}
require('biomaRt') # you might have to install this with Bioconductor (see Erika's instructions)
ensembl.m <- useMart("ensembl") 
ensembl <- useDataset("hsapiens_gene_ensembl", mart=ensembl.m) 
 
ychr.genes <- getBM(attributes= "hgnc_symbol",
                      filters=c("chromosome_name"),
                      values=list("Y"), mart=ensembl) 

# write this to a file so you don't have to load it from ENSEMBL every time (the ensembl connection sometimes fails)
```



### Sample sex-labeling script

Goal: adapt labelSex function
* See `labelSex()` in `processing_utils.R`
* Input : An expData frame and an (optional) list of samples to label (GSMs - these will be the column names in the expData frame)
  + default behavior - label all the samples
* Output : Data frame with sample IDs and sex labels
 | sample_id | sex  |
 | --------- | ---- |
 | GSMxxxx   | male |

* Common issues - make sure you can deal with these (my code doesn't fix these all)
  + [MetaIntegrator can't download a study]
  + input isn't good - i.e. the GSMs are not the column names of the expData
  + sometimes there are no y chromosome probes
  + sometimes the samples are all one sex! then the results will look terrible
  + sometimes the samples are all from the same person / cell line - this will also not work


This might be helpful for info about vectors:
https://www.safaribooksonline.com/library/view/learning-r/9781449357160/ch04.html

A lot of R packages have a vignette that helps go through a worked example.
Install massiR (using bioconductor) and go through the massiR vignette example:
(https://www.bioconductor.org/packages/release/bioc/vignettes/massiR/inst/doc/massiR_Vignette.pdf)

Then get this to work on one of your examples

For reference - this is the code I used to do this. I'd look at this after getting it to work and understanding it based on the example - I just adapted the example code. 
```{r}
require('massiR') # you will probably have to install it

labelSex <- function(expData, ds.keys, ychr.genes, threshold=3, plot=TRUE){
  
  # check that there are y chromosome probes, if there are none, return an error
  ds.keys2 <- ds.keys[!is.na(ds.keys)] # remove NAs
  ychr.probes <- names(ds.keys2)[as.vector(ds.keys2) %in% ychr.genes] # select y chromosome probes
  if (length(ychr.probes)==0){
    print("error, no y chromosome probes")
    return(NULL)
  }
  
  # label sex
  ychr.df <- data.frame(row.names=unique(ychr.probes))  # create an empty dataframe with just y chromosome probes as row names
  
  # run massiR standard functions
  ds.y.out <- massi_y(data.frame(expData), ychr.df)
  massi_y_plot(ds.y.out) # -- selecting threshold
  
  massi.select.out <-
    + massi_select(data.frame(expData), ychr.df, threshold=threshold) # default threshold 3 - may want to adjust
  
  head(massi.select.out)[,1:5]
  results <- massi_cluster(massi.select.out)
  sample.results <- data.frame(results[[2]])
  head(sample.results)
  print(table(sample.results$sex))
  if (plot==TRUE){
    massi_cluster_plot(massi.select.out, results) # you want separated clusters here - can you think of how to check for this?
  }
  
  return(sample.results)
}
```

A couple studies to try next (or anything else you want):
* GSE26487
* GSE70774
* GSE70821


Let's focus on sample sex labeling.
What are the things that can make this hard to automate?



### Taking a deeper dive into the sample metadata to get sample drug labels
We are going to use the fields in the `pheno` data to label individual samples - instead of just the studies. 
One of the big problems with the CREEDS data is that the labels are for the **studies** and not the samples (or drug instances).
As a result, the cell type, drug, organism labels are not helpful if there are multiple in a single study. 

Download a couple studies.
We are going to put together the unique columns of the pheno data and then use this to label the samples.
We are using the unique columns so that we look at sample rather than study-level data. 

Example
```{r}
gse <- getGEOData("GSE50831")
pData <- gse$originalData$GSE50831$pheno

# identify number of levels for each column
# why does this work? - make sure you understand
pData.factor <- apply(pData, 2, as.factor) # convert columns to factor. why is there a "2" here? look up `apply`
nlevels.per.col <- apply(pData.factor, 2, nlevels) 
sample.specific.cols <- colnames(pData.factor)[nlevels.per.col!= 1] 

# Note on dealing with two-channels arrays:
# Some of the arrays will have two channels - this means that the data 
# if this is the case, the pheno data will have columns with ch2 and ch1.
# We will have to divide up the sample data based on this

# note: geo_accession and supplementary_file are not helpful
sample.descript.cols <- setdiff(sample.specific.cols, c("geo_accession", "supplementary_file"))
summary(pData.factor[,sample.descript.cols])

# note - do you notice any misspellings? look at "description" column for this example. we have to be careful! it's human-annotated

# studies will have very variable numbers of columns

# now put this together into a single field - you will want to use "paste"
sample.labels <- apply(pData[,sample.descript.cols], 1, function(x) paste(x, collapse="\t"))
# what does this command do? how does it do this?
# using pData this because we want character version
# why are we using a "1"" here?

# Write this to a file 

# We will then search this like we were discussing for label drugs
# 1) using drugbank labels
# 2) using BRENDA tissue ontology terms (this is what ALE did)

# We will use another coding language to look at this


```



### Stop here, we are going to integrate this with ALE data now!
- this should give us tissue labels


### Body tissues, primary/embryonic stem cells, vs. cell lines

Expand this:
* Which drug instances (`id`) mention "body tissue" in humans?
* Which drug instances do not mention "body tissue" but also do not contain "Cultured Cell Line"?
* Select a couple examples for each - look these up in GEO. Are these really tissues or primary cells?


Find a study or two with more than one human cell line - try to sex-label this. What happens?
* Why do we need multiple cell lines instead of just one?
* Look up the original sex of these cell lines - does it match what you see?

Species Challenges:
* We want to sex label rat + mice samples too - what are the challenges here?
  + one thing: we need a different list of y chromosome genes! (not hsapiens_gene_ensembl) - look this up
  + set it up to work with this
* What about studies with multiple organisms? Multiple cell types within the same organism?










